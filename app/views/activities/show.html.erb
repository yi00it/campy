<% can_toggle_state = can_manage_project?(@activity.project) || (project_role(@activity.project) == :subcontractor && @activity.assignee_id == current_user.id) %>
<% can_comment = can_comment_on_activity?(@activity) %>
<% can_edit_activity = can_manage_project?(@activity.project) %>

<div class="activity-detail stack">
  <section class="card card--activity">
    <div class="activity-card__header">
      <div class="activity-card__summary">
        <div class="list-inline">
          <span class="pill<%= " pill--done" if @activity.is_done %>"><%= @activity.is_done ? "Done" : "Open" %></span>
          <% if @activity.start_on.present? %>
            <span class="pill pill--frost">Starts <%= @activity.start_on.to_fs(:long) %></span>
          <% end %>
          <% if @activity.due_on.present? %>
            <% due_class = @activity.due_on < Date.current && !@activity.is_done ? " pill--overdue" : "" %>
            <span class="pill<%= due_class %>">Due <%= @activity.due_on.to_fs(:long) %></span>
          <% else %>
            <span class="pill">No due date</span>
          <% end %>
          <% if @activity.zone.present? %>
            <span class="pill pill--sunrise"><%= @activity.zone.name %></span>
          <% end %>
          <% if @activity.discipline.present? %>
            <span class="pill pill--frost"><%= @activity.discipline.name %></span>
          <% end %>
        </div>

        <h2 class="section__title section__title--sm mt-sm"><%= @activity.title %></h2>
        <p class="meta">Part of <%= link_to @activity.project.name, @activity.project %></p>
      </div>

      <% if can_comment %>
        <div class="activity-card__share" data-controller="modal">
          <button type="button" class="btn btn--primary btn--share" data-action="modal#open">Share update</button>
          <div class="modal" data-modal-target="container" hidden>
            <div class="modal__backdrop" data-modal-target="backdrop" data-action="click->modal#handleBackdrop" aria-hidden="true"></div>
            <div class="modal__dialog" data-modal-target="dialog" role="dialog" aria-modal="true">
              <button type="button" class="modal__close btn btn--text" data-action="modal#close" data-modal-close aria-label="Close update dialog">Close</button>
              <div class="modal__content">
                <h3 class="section__title section__title--sm section__title--flush">Share an update</h3>
                <p class="meta">Keep everyone synced with quick notes and supporting files.</p>
                <%= form_with(model: [@activity, @update], local: true, html: { multipart: true }) do |form| %>
                  <div class="field">
                    <%= form.label :body, "What's new?" %>
                    <%= form.text_area :body, rows: 4 %>
                  </div>
                  <div class="field">
                    <%= form.label :files, "Attach files" %>
                    <%= form.file_field :files, multiple: true %>
                  </div>
                  <div class="actions">
                    <%= form.submit "Post update", class: "btn btn--primary" %>
                    <button type="button" class="btn btn--ghost" data-action="modal#close" data-modal-close>Cancel</button>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <hr class="hr">
    <div class="stack">
      <%= simple_format(@activity.description.presence || "Share a few sentences that give teammates clarity and confidence.") %>
      <div class="list-inline list-inline--spread meta-bar">
        <span class="meta"><strong>Starts:</strong> <%= @activity.start_on&.to_fs(:long) || "Not set" %></span>
        <span class="meta"><strong>Due:</strong> <%= @activity.due_on&.to_fs(:long) || "Not set" %></span>
        <span class="meta"><strong>Zone:</strong> <%= @activity.zone&.name || "Not set" %></span>
        <span class="meta"><strong>Discipline:</strong> <%= @activity.discipline&.name || "Not set" %></span>
        <span class="meta"><strong>Assigned to:</strong> <%= @activity.assignee&.display_name || "Unassigned" %></span>
      </div>
    </div>

    <% if @activity.files.attached? && can_access_activity_files?(@activity) %>
      <div class="attachments-block mt-md">
        <h3 class="section__title section__title--sm section__title--flush">Files</h3>
        <ul class="attachments-list list-reset mt-sm">
          <% @activity.files.each do |file| %>
            <li class="attachment-chip">
              <span class="attachment-chip__icon">ðŸ“Ž</span>
              <div class="attachment-chip__meta">
                <strong><%= link_to file.filename.to_s, rails_blob_path(file, disposition: "attachment") %></strong>
                <small><%= [file.content_type, number_to_human_size(file.byte_size)].compact.join(" Â· ") %></small>
              </div>
            </li>
          <% end %>
        </ul>
      </div>
    <% elsif @activity.files.attached? %>
      <div class="attachments-block mt-md">
        <h3 class="section__title section__title--sm section__title--flush">Files</h3>
        <p class="meta meta--note">You donâ€™t have permission to download files for this activity.</p>
      </div>
    <% end %>

    <div class="hero__cta mt-md">
      <% if can_toggle_state %>
        <%= button_to (@activity.is_done ? "Mark as undone" : "Mark as done"),
                      toggle_done_activity_path(@activity),
                      method: :patch,
                      class: "btn btn--primary",
                      form: { data: { turbo: true } } %>
      <% end %>
      <% if can_edit_activity %>
        <%= link_to "Edit", edit_activity_path(@activity), class: "btn btn--ghost" %>
      <% end %>
      <%= link_to "Back to project", project_path(@activity.project), class: "btn btn--text" %>
    </div>
  </section>

  <section class="card card--updates">
    <div class="list-inline list-inline--spread">
      <h3 class="section__title section__title--sm section__title--flush">Updates</h3>
      <span class="meta"><%= pluralize(@updates.count, "entry") %></span>
    </div>

    <% if @updates.any? %>
      <ul class="updates-list list-reset mt-md">
        <% @updates.each do |update| %>
          <li class="update" id="<%= dom_id(update) %>">
            <header class="update__header">
              <strong><%= update.author&.display_name || "Teammate" %></strong>
              <span class="meta">Â· <%= time_ago_in_words(update.created_at) %> ago</span>
            </header>
            <div class="update__body">
              <%= simple_format(update.body) %>
            </div>
            <% if update.files.attached? && can_access_activity_files?(@activity) %>
              <div class="update__files">
                <ul class="attachments-list attachments-list--compact list-reset">
                  <% update.files.each do |file| %>
                    <li class="attachment-chip">
                      <span class="attachment-chip__icon">ðŸ“Ž</span>
                      <div class="attachment-chip__meta">
                        <strong><%= link_to file.filename.to_s, rails_blob_path(file, disposition: "attachment") %></strong>
                        <small><%= [file.content_type, number_to_human_size(file.byte_size)].compact.join(" Â· ") %></small>
                      </div>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            <%= turbo_frame_tag dom_id(update, :reactions) do %>
              <%= render "comments/reactions", comment: update, reaction_emojis: @reaction_emojis %>
            <% end %>
            <% if update.replies.any? %>
              <div class="update__replies">
                <% update.replies.order(:created_at).each do |reply| %>
                  <div class="update__reply" id="<%= dom_id(reply) %>">
                    <header class="update__reply-header">
                      <strong><%= reply.author&.display_name || "Teammate" %></strong>
                      <span class="meta">Â· <%= time_ago_in_words(reply.created_at) %> ago</span>
                    </header>
                    <div class="update__reply-body">
                      <%= simple_format(reply.body) %>
                    </div>
                    <footer class="update__reply-actions">
                      <%= turbo_frame_tag dom_id(reply, :reactions) do %>
                        <%= render "comments/reactions", comment: reply, reaction_emojis: @reaction_emojis %>
                      <% end %>
                      <% if can_edit_activity || reply.author_id == current_user.id %>
                        <%= link_to "Delete", reply, data: { turbo_method: :delete, turbo_confirm: "Delete this reply?" }, class: "btn btn--text" %>
                      <% end %>
                    </footer>
                  </div>
                <% end %>
              </div>
            <% end %>
            <% if can_comment %>
              <div class="update__reply-form">
                <%= form_with(model: [@activity, Comment.new], local: true, class: "reply-form") do |form| %>
                  <%= form.hidden_field :parent_id, value: update.id %>
                  <div class="field">
                    <%= form.label :body, "Add a reply", class: "visually-hidden" %>
                    <%= form.text_area :body, rows: 2, placeholder: "Write a commentâ€¦" %>
                  </div>
                  <div class="actions">
                    <%= form.submit "Reply", class: "btn btn--ghost" %>
                  </div>
                <% end %>
              </div>
            <% end %>
            <% if can_edit_activity || update.author_id == current_user.id %>
              <footer class="update__actions">
                <%= link_to "Delete update", update,
                      data: { turbo_method: :delete, turbo_confirm: "Delete this update?" },
                      class: "btn btn--text" %>
              </footer>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% else %>
      <div class="empty-state">No updates yet. Drop the first one to set the tone.</div>
    <% end %>
  </section>
</div>
